define(["accountModel/AccountModel","commonController/MainController","Native","pAQuickPayCommonModel/PAShakeTool","utils"],function(AccountModel,MainController,Native,ShakeTool,utils){var AccountController=MainController.extend({module:"account",name:"account",actions:{login:"login","login/:id":"login","login4RYM/:encodeLoginJSON":"login4RYM",loginSuccess:"loginSuccess",loginBindSuccess:"loginBindSuccess",loginBind:"loginBind",OrdinaryLogin:"OrdinaryLogin",UsbKeyLogin:"UsbKeyLogin",ksLogin:"validatePassword"},accountModel:null,loginName:null,loginView:null,login:function(){var e=this;this.accountModel=new AccountModel,wrapView.setHeader(wrapView.headerView,{controller:e,isLogin:!0,title:{leftBtn:"返回",info:"登录",leftBtnClick:function(){PAWA.router.navigate("home/home/index",!0),PAWA.PAWAModel.shareModels.remove("goWhere")},rightBtn:"注册",rightBtnClick:function(){PAWA.router.navigate("register/Register/index",!0)}}}),require(["commonView/HeaderView","accountView/LoginView"],function(t,n){e.loginView=wrapView.setBody(n,{controller:e}),e.loginView.render()}),PAWA.CommonTools.talkingDataTrackEvent("首页-登录")},login4RYM:function(encodeLoginJSON){var decodeLoginJSON=decodeURIComponent(encodeLoginJSON),loginParam=eval("("+decodeLoginJSON+")");loginParam.loginDeviceID=ShakeTool.getDeviceId();var self=this;self.accountModel=new AccountModel,self.accountModel.login4RYM(loginParam,function(){PAWA.PAWAModel.shareModels.add("User_Login_Success",!0);var e=PAWA.PAWAModel.shareModels.get("User_Bank_Type"),t=PAWA.PAWAModel.shareModels.get("CFE_INFO");if(t&&t.accCfe||e&&e.value==4){var n=PAWA.PAWAModel.shareModels.get("Login_Info_Data");if(n.loginOtpBindFlag&&(n.loginOtpBindFlag=="0"||n.loginOtpBindFlag=="2")){PAWA.router.navigate("account/account/loginBind",!0);return}}if(e&&e.value==3){PAWA.router.navigate("account/account/UsbKeyLogin",!0);return}if(e&&e.value==2){PAWA.router.navigate("account/account/OrdinaryLogin",!0);return}self.loginSuccess()},function(e){PAWA.router.navigate("account/account/login",!0)})},loginSubmit:function(e){var t=this;t.loginName=e.userId||e.loginName||"",wrapView.headerView.disableEvent(),this.accountModel.login(e,function(){PAWA.PAWAModel.shareModels.add("User_Login_Success",!0),wrapView.headerView.enableEvent();try{t.loginView.isRemember==1?Native.saveData({key:"userName",value:t.loginName},function(){},function(){}):Native.saveData({key:"userName",value:""},function(){},function(){})}catch(e){}var n=PAWA.PAWAModel.shareModels.get("User_Bank_Type"),r=PAWA.PAWAModel.shareModels.get("CFE_INFO");if(r&&r.accCfe||n&&n.value==4){var i=PAWA.PAWAModel.shareModels.get("Login_Info_Data");if(i.loginOtpBindFlag&&(i.loginOtpBindFlag=="0"||i.loginOtpBindFlag=="2")){PAWA.router.navigate("account/account/loginBind",!0);return}}if(n&&n.value==3){PAWA.router.navigate("account/account/UsbKeyLogin",!0);return}if(n&&n.value==2){PAWA.router.navigate("account/account/OrdinaryLogin",!0);return}t.loginSuccess()},function(e){$("#loginVCodeDiv").show(),PAWA.PAWAModel.shareModels.add("Login_showVCodeFlag","1"),wrapView.headerView.enableEvent(),t.loginView.changeVCode(),e.errCode==="102"?wrapView.FlipPrompt.alert({content:e.errMsg},function(){t.loginView.clearPassWord()}):e.errCode==="104"||e.errCode==="105"?wrapView.FlipPrompt.alert({content:e.errMsg},function(){t.loginView.clearVCode()}):(t.loginView.clearPassWord(),t.loginView.clearVCode())})},loginBindSuccess:function(){var e=PAWA.PAWAModel.shareModels.get("User_Bank_Type");if(e&&e.value==3){PAWA.router.navigate("account/account/UsbKeyLogin",!0);return}if(e&&e.value==2){PAWA.router.navigate("account/account/OrdinaryLogin",!0);return}this.loginSuccess()},loginSuccess:function(){var e=null,t=PAWA.PAWAModel.shareModels.get("Login_Info_Data"),n=PAWA.PAWAModel.shareModels.get("User_Verify_Data"),r=PAWA.PAWAModel.shareModels.get("User_Bank_Type"),i=PAWA.PAWAModel.shareModels.get("User_Info_Data"),s=null;t.userType=="0"?s={userType:"0",loginName:this.loginName||"",username:t.cnName||"",partyNo:t.toaPartyNo||"",lastLogonSuccessDate:t.lastLogonSuccessDateStr||""}:s={userType:t.userType||"",loginName:this.loginName||"",username:t.username||"",partyNo:t.toaPartyNo||"",lastLogonSuccessDate:t.lastLogonSuccessDateStr||""};var e={appconfig:{clientHost:""},noticeInfo:{num:0},loginInfo:t,userInfo:s,userVerifyData:n,userBankType:r};wrapView.device!=""&&Native.login(e);var o=PAWA.CommonTools.desEncode(this.loginName),u=PAWA.PAWAModel.shareModels.get("User_Card_Type")||"";Native.talkingDataCollectUser({userID:o,userType:u}),PAWA.CommonTools.talkingDataTrackEvent("首页-登录成功页"),Native.isFirstSetGesturePwd(function(e){if(e)return;Native.getData("safeLoginOut",function(e){if(e!=1)return;Native.saveGestureLoginOpenFlag(!0,function(){}),Native.saveData({key:"safeLoginOut",value:"0"},function(){})})}),this.bindNoticeCenter()},goSuccessView:function(){function i(){var e=PAWA.PAWAModel.shareModels,t=e.get("goWhere"),n=e.get("Login_Info_Data").loginOtpBindFlag,i=e.get("rightNow");i=="1"&&n=="1"?(t&&e.add("rightNow","2"),PAWA.router.navigate("#/saveCenter/loginPassModify/gesturePassModify/index",!0)):t?PAWA.router.navigate(t,!0):wrapView.goHome(),window.NATIVE_APP_VERSION>="2.5.6"&&setTimeout(function(){r.request("qryCreditCardPromotion",function(e){e.market_plan==="A"&&e.popup_state=="1"&&(PAWA.CommonTools.talkingDataTrackEvent("首页-信用卡营销弹窗"),Native.PromotionBombBox(function(e){var t=e.toLowerCase();t=="left"?(PAWA.CommonTools.talkingDataTrackEvent("首页-信用卡营销弹窗_不再提示"),r.request("noPromotionCreditCard")):(PAWA.CommonTools.talkingDataTrackEvent("首页-信用卡营销弹窗_去申请"),Native.openThirtyWebView({title:"白金信用卡申请",isShowHerder:!0,url:utils.getAppConfig("Common_URL",{}).BouncedWhiteGoldCreditUrl}))}))})},1e3)}var e=!1,t=PAWA.PAWAModel.shareModels.get("isRecommend"),n=PAWA.PAWAModel.shareModels.get("firstLogonFlag")=="0";if(t&&n){wrapView.FlipPrompt.confirm({title:"欢迎",content:'<i style="text">您好，欢迎登录平安口袋银行</i><input placeholder="请输入推荐码" id="comfirmInfo" class="input_recommend" style="margin-top:8px" type="text"><span id="comfirmMsg" class="wordbreak m_t6 lh22 tal f_c_dd5522" style="display:none;"></span>',FBntConfirmColor:"pop_btn_grey",FBntCancelColor:"pop_btn_orange",FBntconfirm:"跳过",FBntcancel:"确定",recommendCode:!0},function(){i()},function(){var t=$.trim($("#comfirmInfo").val());if(t!=""){$("#comfirmInfo").attr("disabled","disabled");var n=$(".pop1_btn [action=FBntcancel]");n.removeClass("pop_btn_orange").addClass("pop_btn_disabled"),e||(e=!0,PAWA.Request("saveRecommend",{cancelLightbox:!0,data:{recommendCode:t},success:function(t){e=!1,t.errCode=="000"?i():($("#comfirmMsg").css({display:"table"}),$("#comfirmMsg").html(t.errMsg)),$("#comfirmInfo").removeAttr("disabled"),n.removeClass("pop_btn_disabled").addClass("pop_btn_orange")},error:function(){e=!1,i(),$("#comfirmInfo").removeAttr("disabled"),n.removeClass("pop_btn_disabled").addClass("pop_btn_orange")}}))}else $("#comfirmMsg").css({display:"table"}),$("#comfirmMsg").html("推荐码不能为空！")});return}i(),Native.getAppConfig(function(e){var t=e.Application.Notice_Switch;t=="true"&&PAWA.Request("qryFirstLoginIsNotice",{cancelLightbox:!0,success:function(e){e.errCode=="000"&&e.responseBody.isShow=="1"&&Native.showNotice(e.responseBody.activitySubject)}})},function(){});var r=this},request:function(e,t){var n=t||function(){};PAWA.Request(e,{type:"POST",success:function(e){if(e.ret_code==="000000"){var t=e.response_body;n(t)}},error:function(){}})},loginBind:function(){var e=this,t=this.accountModel;wrapView.setHeader(wrapView.headerView,{controller:e,isLogin:!0,title:{leftBtn:"返回",info:"安全验证",leftBtnClick:function(){PAWA.CommonTools.logout(!0)}}}),require(["commonView/HeaderView","accountView/LoginBindView"],function(n,r){var i=wrapView.setBody(r,{controller:e,model:t});i.render(),i.initOtpServer()}),PAWA.CommonTools.talkingDataTrackEvent("首页-OTP登录")},toRegister:function(){PAWA.router.navigate("register/Register/index",!0)},OrdinaryLogin:function(){var e=this;wrapView.setHeader(wrapView.headerView,{title:{leftBtn:"返回",info:"安全验证",leftBtnClick:function(){PAWA.CommonTools.logout(!0)}}}),require(["commonView/HeaderView","accountView/OrdinaryLoginView"],function(t,n){var r=wrapView.setBody(n,{controller:e});r.render()}),PAWA.CommonTools.talkingDataTrackEvent("首页-普通网银客户登录")},UsbKeyLogin:function(){var e=this;require(["commonView/HeaderView","accountView/UsbKeyLoginView"],function(t,n){wrapView.setHeader(wrapView.headerView,{title:{leftBtn:"返回",info:"安全验证",leftBtnClick:function(){PAWA.CommonTools.logout(!0)}}});var r=wrapView.setBody(n,{controller:e});r.render()}),PAWA.CommonTools.talkingDataTrackEvent("首页-UKEY客户登录")},updateNoticeNum:function(){var e=PAWA.PAWAModel.shareModels.get("Notice_Center_Num");Native.setNoticeNum(e||"0")},bindNoticeCenter:function(){var e=this,t=e.getDeviceId();if(wrapView.device==""){var n=PAWA.PAWAModel.shareModels.get("Login_Info_Data"),r=n.noticeBindFlag||"";e.canPush(r)}else this.isShowPushAlert(function(n){if(n){var r=PAWA.PAWAModel.shareModels.get("Login_Info_Data"),i=r.noticeBindFlag||"";e.canPush(i)}else e.goSuccessView(),e.accountModel.qryNoticeCenterList(t,e.updateNoticeNum)})},isShowPushAlert:function(e){console.log("check is show push alert 1");var t=this.loginName;Native.getData("loginHistoryList",function(n){if(!n||n==undefined){e(!0);return}var r=JSON.parse(n),i=_.contains(_.keys(r),t);console.log(r),i?e(!1):e(!0)},function(){e(!1)})},saveBlackList:function(e){var t=this;if(wrapView.device=="")e();else{var n=this.loginName;console.log(n);var r={};Native.getData("loginHistoryList",function(t){var i;try{i=JSON.parse(t)}catch(s){i={}}i!=null&&typeof i!="object"&&(i={}),i==null&&(i={}),console.log(typeof i),r=i,r[n]=1;var o=JSON.stringify(r),u={key:"loginHistoryList",value:o};Native.saveData(u,e,e)},e)}},getDeviceType:function(){var e=navigator.userAgent.toLowerCase(),t=e.indexOf("android")!=-1,n=e.indexOf("iphone os")!=-1,r=e.indexOf("ipad os")!=-1,i;return t?i="android":n?i="iphone":r?i="ipad":i="unknow",console.log("deviceType"),console.log(i),i},getDeviceId:function(){var e=PAWA.PAWAModel.shareModels.get("Bank_Device_Id")||"";if(e.length!=0)return e;Native.getDeviceId(function(e){return PAWA.PAWAModel.shareModels.add("Bank_Device_Id",e||""),e||""})},getTokenId:function(e){require(["Native"],function(){Native.getDeviceToken(function(t){console.log(t),t?e(t):e()},function(){console.log("tokenId------------fail"),e()})})},canPush:function(e){PAWA.PAWAModel.shareModels.add("noticeCenter/bindFlag",!1);var t=this.getDeviceId(),n=this;if(e!="1"){wrapView.headerView.disableEvent();var r="您是否同意平安银行手机网银向该手机推送通知？";wrapView.FlipPrompt.confirm({title:"温馨提示",content:r,FBntconfirm:"拒绝",FBntcancel:"同意",FBntConfirmColor:"pop_btn_grey",FBntCancelColor:"pop_btn_orange"},function(){setTimeout(function(){n.goSuccessView()},200),n.saveBlackList(function(){n.accountModel.qryNoticeCenterList(t,n.updateNoticeNum)}),wrapView.headerView.enableEvent()},function(){var e=n.getDeviceType(),r="";setTimeout(function(){n.goSuccessView()},200),wrapView.headerView.enableEvent(),e=="iphone"||e=="ipad"?n.getTokenId(function(i,s){i?(console.log(i),r=i,n.requestNoticeBind(e,t,"1",r,function(){n.accountModel.qryNoticeCenterList(t,n.updateNoticeNum)})):n.accountModel.qryNoticeCenterList(t,n.updateNoticeNum)}):n.requestNoticeBind(e,t,"1",r,function(){n.accountModel.qryNoticeCenterList(t,n.updateNoticeNum)})})}else setTimeout(function(){n.goSuccessView()},30),PAWA.PAWAModel.shareModels.add("noticeCenter/bindFlag",!0),n.accountModel.qryNoticeCenterList(t,n.updateNoticeNum)},requestNoticeBind:function(e,t,n,r,i){console.log("接受推送绑定 requestNoticeBind start");var s=this,o={};o.deviceId=t,o.bindFlag=n;if(e=="iphone"||e=="ipad")o.tokenId=r;console.log(o),PAWA.Request("noticeBind",{cancelLightbox:!0,data:o,success:_.bind(function(e){console.log("接受推送绑定:"),console.log(e),e.errCode=="000"?(PAWA.PAWAModel.shareModels.add("noticeCenter/bindFlag",!0),console.log("接受推送绑定 success")):console.log("接受推送绑定 fail"),i()},s),error:function(e){console.log("接受推送绑定 fail"),i()}})},validatePassword:function(){var e=this;wrapView.setHeader(wrapView.headerView,{controller:e,isLogin:!0,title:{leftBtn:"返回",info:"密码校验",leftBtnClick:function(){wrapView.goHome()}}}),require(["app/modules/account/view/KsLoginView"],function(e){wrapView.bodyView&&wrapView.bodyView instanceof e&&(wrapView.bodyView.destroy(),wrapView.bodyView=null),wrapView.setBody(e,{templateType:2,onLoginSuccess:function(){var e=PAWA.PAWAModel.shareModels.get("goWhere");e&&e.indexOf("account/account/login")!=0?PAWA.router.navigate(e,!0):wrapView.goHome()},onCancel:function(){wrapView.goHome()}})})}});return AccountController});